---
title: "GLMM"
lang: es
bibliography: references.bib
---

```{r}
#| id: Configuraci√≥n y carga de paquetes
#| echo: false
# Configuraci√≥n global
knitr::opts_chunk$set(
  echo = TRUE,
  message = FALSE,
  warning = FALSE,
  fig.align = "center",
  out.width = "85%",
  dpi = 300
)

# Cargar paquetes
pacman::p_load(
   patchwork,
    flextable,
    glmmTMB,
    easystats,
    janitor,
    tidyverse
)
```

### Introducci√≥n

-   En muchos estudios epidemiol√≥gicos, las observaciones no son independientes entre s√≠. Por ejemplo:

    -   Estudios longitudinales con **medidas repetidas** sobre los mismos individuos.

    -   Estudios transversales o caso-control con **datos agrupados** por unidades espaciales (provincias, ciudades, barrios, etc.).

    -   Estudios experimentales donde los participantes se asignan a **distintos grupos** y se eval√∫an en diferentes momentos.

------------------------------------------------------------------------

-   Estos contextos generan dependencia espacial y/o temporal, dando lugar a una estructura de datos **agrupada** o **jer√°rquica**.

-   Las observaciones se organizan en **cl√∫sters** (individuos, grupos, unidades geogr√°ficas, etc.) y suelen estar **correlacionadas**.

-   Ignorar la correlaci√≥n dentro de los cl√∫sters puede llevar a **subestimar los errores est√°ndar** y, en consecuencia, a realizar inferencias incorrectas.

------------------------------------------------------------------------

#### ¬øQu√© son los modelos mixtos?

-   Son una extensi√≥n de los GLM, que incorporan **efectos aleatorios** en el predictor lineal.

-   Esto permite modelar simult√°neamente:

    -   La **relaci√≥n sistem√°tica** entre la media y las covariables.

    -   La **estructura de correlaci√≥n** entre observaciones dentro de un mismo grupo.

-   De este modo, se captura la **dependencia** entre observaciones mediante la inclusi√≥n de componentes **aleatorios** que representan la variabilidad entre cl√∫sters.

------------------------------------------------------------------------

#### Componentes del modelo

-   Los modelos mixtos se componen de dos partes:

    -   **Efectos fijos:** covariables cuyo efecto se estima sobre la media de la respuesta. Son par√°metros **comunes a toda la poblaci√≥n** bajo estudio.

    -   **Efectos aleatorios:** variabilidad adicional atribuible a los cl√∫sters. Modelan la correlaci√≥n intra-cl√∫ster y representan la **variabilidad no explicada** entre unidades del mismo grupo.

------------------------------------------------------------------------

::: {.callout-warning .center style="font-size: 2.5em;" appearance="simple"}
Los efectos fijos describen la **tendencia** promedio en la poblaci√≥n, mientras que los efectos aleatorios capturan la **variabilidad** entre los distintos cl√∫sters.
:::

------------------------------------------------------------------------

#### ¬øCu√°ndo incluir efectos aleatorios?

-   La variable que define los cl√∫sters tiene al menos **cinco niveles**.
-   Los niveles representan una **muestra aleatoria** de una poblaci√≥n de posibles cl√∫sters.
-   Se busca modelar la **correlaci√≥n intra-cl√∫ster**.
-   La variable es parte de la **estructura de dise√±o** del estudio.
-   El efecto de esa variable **no es de inter√©s directo**.
-   No nos interesa realizar **comparaciones** ni **inferencias** sobre sus niveles.

------------------------------------------------------------------------

### Modelos mixtos con distribuci√≥n normal (LMM)

-   Extensi√≥n del modelo lineal general que incluye un t√©rmino aleatorio asociado a cada cl√∫ster:

    $$ y_{ij} = x_{ij}\beta + z_{ij} u_i + \epsilon_{ij} \qquad donde:~u_i ~ N(0, \sigma^2_u) ~ y ~ \epsilon_{ij} ~ N(0, \sigma^2_\epsilon)$$

-   Esto permite que cada grupo tenga su propio nivel promedio y/o su propia tendencia en la variable respuesta.

-   Supone normalidad e independencia de los errores y los efectos aleatorios.

------------------------------------------------------------------------

#### Intercepto aleatorio

-   Cuando $z_{ij} = 1$, el efecto aleatorio est√° dado por una **variable categ√≥rica** que identifica los cl√∫sters.

-   En este caso, cada cl√∫ster va a tener su propio **intercepto** para la variable respuesta.

-   Las rectas de regresi√≥n para cada cl√∫ster ser√°n paralelas (misma pendiente).

-   Las **diferencias entre cl√∫sters** permiten modelar la heterogeneidad entre grupos sin estimar un par√°metro espec√≠fico para cada uno.

-   Similar al ANOVA de medidas repetidas o por bloques.

------------------------------------------------------------------------

#### Pendiente aleatoria

-   Cada cl√∫ster puede responder de forma **diferente** a una covariable num√©rica.

-   Las pendientes aleatorias permiten que la **magnitud y/o direcci√≥n** del efecto var√≠e entre cl√∫sters.

-   Es conveniente incorporarlas cuando:

    -   Los par√°metros espec√≠ficos de cada cl√∫ster muestran una alta variabilidad.

    -   La variabilidad intra-cl√∫ste**r** es baja.

    -   Hay un gran n√∫mero de observaciones por cl√∫ster.

------------------------------------------------------------------------

### Modelos mixtos en R

-   Los paquetes m√°s comunes para ajustar GLMMs son:

    | Paquete   | Funci√≥n/es                         | Modelos             |
    |-----------|------------------------------------|---------------------|
    | `nlme`    | `lme()`                            | LMM                 |
    | `lme4`    | `lmer()`, `glmer()` y `glmer.nb()` | LMM y GLMM          |
    | `glmmTMB` | `glmmTMB()`                        | LM, GLM, LMM y GLMM |

-   Usaremos **`glmmTMB`** por su **flexibilidad**: permite ajustar modelos con/sin efectos aleatorios y usar distribuciones no gaussianas.

------------------------------------------------------------------------

#### Ejemplo: estudio de privaci√≥n de sue√±o

-   El dataset `sleepstudy`, incluido en `lme4`, contiene informaci√≥n sobre el tiempo de reacci√≥n diario en 18 personas con privaci√≥n de sue√±o.

-   Variables:

    -   `reaction`: tiempo de reacci√≥n promedio (ms)

    -   `days`: n√∫mero de d√≠as de insomnio

    -   `subject`: identificador de participante

-   Evaluaremos la relaci√≥n entre d√≠as de privaci√≥n de sue√±o y tiempo de reacci√≥n.

------------------------------------------------------------------------

##### Regresi√≥n lineal simple

```{r}
#| id: RLS
# Cargar datos
sleepstudy <- lme4::sleepstudy |>
  tibble() |>
  # Estandarizar nombres de columnas
  clean_names()

# Ajustar RLS
mod_lm <- glmmTMB(reaction ~ days, data = sleepstudy) 

parameters(mod_lm, effects = "fixed", include_info = TRUE)
```

------------------------------------------------------------------------

##### RLM: `subject` como efecto fijo

```{r}
#| id: RLM
mod_rlm1 <- glmmTMB(reaction ~ days + subject, data = sleepstudy)

parameters(mod_rlm1, effects = "fixed", include_info = TRUE)
```

------------------------------------------------------------------------

##### RLM: interacci√≥n entre `subject` y `days`

```{r}
#| id: RLM con interacci√≥n
mod_rlm2 <- glmmTMB(reaction ~ days + days:subject, data = sleepstudy)

parameters(mod_rlm2, effects = "fixed", include_info = TRUE)
```

------------------------------------------------------------------------

##### LMM: `subject` como intercepto aleatorio

```{r}
#| id: LMM con intercepto aleatorio
mod_lmm1 <- glmmTMB(reaction ~ days + (1 | subject), data = sleepstudy)

parameters(mod_lmm1, include_info = TRUE)
```

------------------------------------------------------------------------

##### LMM: `subject` como intercepto y `days` como pendiente aleatorios

```{r}
#| id: LMM con intercepto y pendiente aleatorios
mod_lmm2 <- glmmTMB(reaction ~ days + (days | subject), data = sleepstudy)

parameters(mod_lmm2, include_info = TRUE)
```

------------------------------------------------------------------------

##### Comparaci√≥n de modelos

```{r}
#| id: Comparar modelos
compare_performance(
  mod_lm,
  mod_rlm1, mod_rlm2,
  mod_lmm1, mod_lmm2,
  metrics = "common", rank = TRUE
)
```

```{r}
#| id: Gr√°fico performance
#| echo: false
#| output-location: slide
compare_performance(
  mod_lm,
  mod_rlm1, mod_rlm2,
  mod_lmm1, mod_lmm2,
  metrics = "common", rank = TRUE
) |>  
    plot()
```

------------------------------------------------------------------------

##### Representaci√≥n gr√°fica

```{r}
#| id: Gr√°fico efectos aleatorios
#| echo: false
## A√±adir predicciones al dataset
datos_plot <- sleepstudy |>
  mutate(pred_i = predict(mod_lmm1, type = "response")) |>

  mutate(pred_p = predict(mod_lmm2, type = "response"))

## Spaghetti plot para intercepto aleatorio
g1 <- datos_plot |>
  ggplot(aes(x = days, y = pred_i, group = subject, color = subject)) +
   labs(x = "D√≠as", y = "Respuesta", title = "Intercepto aleatorio")

## Spaghetti plot para pendiente aleatoria
g2 <- datos_plot |>
  ggplot(aes(x = days, y = pred_p, group = subject, color = subject)) +
  labs(x = "D√≠as", y = "Respuesta", title = "Intercepto y pendiente aleatorios")

## Unir gr√°ficos
g1 +
  g2 +
  plot_layout(ncol = 2, guides = "collect", axes = "collect") &
 geom_point(aes(x = days, y = reaction, group = subject)) &
  geom_line() &
  scale_color_viridis_d() &
  theme_minimal() &
  theme(
      legend.position = "none",  
      #legend.byrow = TRUE,
      title = element_text(face = "bold")
  )
```

------------------------------------------------------------------------

#### Ejemplo: mortalidad por c√°ncer en la costa Este de EEUU

En la [Unidad 3](https://datos-ine.github.io/curso_avanzada_2025/unidad_3/01_est_ecologicos.html) usamos el dataset `cancer_USA.txt` para ejemplificar los distintos casos del modelo lineal general. Repasemos la estructura de los datos:

```{r}
#| id: Cargar dataset c√°ncer
cancer <- read_csv2("cancer_USA.txt")

glimpse(cancer)
```

------------------------------------------------------------------------

-   En el cap√≠tulo de [regresi√≥n lineal m√∫ltiple](https://datos-ine.github.io/curso_avanzada_2025/unidad_3/07_reg_lineal_multiple.html), encontramos asociaciones significativas con `mediana_edad`, `mediana_ingresos`, `pct_desempleo` y `estado`.

-   Cada estado incluye observaciones correspondientes a distintos condados:

    ```{r}
    #| id: Tabla frecuencia x estado
    tabyl(cancer, estado) |>
    adorn_pct_formatting()
    ```

-   A continuaci√≥n, compararemos el modelo de RLM con un LMM, considerando `estado` como **intercepto aleatorio**.

------------------------------------------------------------------------

##### RLM: `estado` como efecto fijo

```{r}
#| id: RLM c√°ncer
mod_rlm <- glmmTMB(
  tasa_mortalidad ~ mediana_ingresos + mediana_edad + pct_desempleo + estado,
  data = cancer
)

parameters(mod_rlm, effects = "fixed", include_info = TRUE)
```

------------------------------------------------------------------------

##### LMM: `estado` como intercepto aleatorio

```{r}
#| id: RLM con intercepto aleatorio
mod_random <- glmmTMB(
  tasa_mortalidad ~ mediana_ingresos + mediana_edad + pct_desempleo +
    (1 | estado), data = cancer
)

parameters(mod_random, include_info = TRUE)
```

------------------------------------------------------------------------

Comparamos los dos modelos:

```{r}
#| id: Comparar performance RLM y LMM
compare_performance(mod_rlm, mod_random, metrics = "common", rank = TRUE)
```

-   Usar `estado` como intercepto aleatorio mejora la performance del modelo y consume menos grados de libertad que usarlo como efecto fijo (**IMPORTANTE** si tenemos pocas observaciones).
-   Adem√°s, permite considerar los estados como una muestra aleatoria de una poblaci√≥n mayor de posibles unidades geogr√°ficas.

------------------------------------------------------------------------

### Modelos mixtos generalizados (GLMM)

-   Analizan datos agrupados o con medidas repetidas con variables respuesta **no normales**.
-   Los **efectos fijos** representan el efecto promedio de las covariables y los **aleatorios** capturan la variabilidad no explicada entre grupos o unidades.
-   Modelan la **dependencia intra-cl√∫ster**, evitando violar la independencia de los residuos.
-   Admiten **distintas distribuciones** (binomial, Poisson, binomial negativa, etc.) y **datos desbalanceados o incompletos**.

------------------------------------------------------------------------

#### Ejemplo: Incidencia de dengue en la Costa Atl√°ntica de PBA

En la [Unidad 5](https://datos-ine.github.io/curso_avanzada_2025/unidad_5/03_dispersion.html), usamos el dataset `dengue_costa.txt` para controlar sobredispersi√≥n mediante la distribuci√≥n binomial negativa. Repasemos la estructura de los datos:

```{r}
#| id: Cargar datos dengue
dengue <- read_delim("dengue_costa.txt")

glimpse(dengue)
```

-   Ahora, nos interesa controlar la **falta de independencia** entre observaciones de un mismo departamento.

------------------------------------------------------------------------

##### GLM: distribuci√≥n binomial negativa

```{r}
#| id: GLM dengue
mod_glm <- glmmTMB(casos ~ semana_epi + grupo_edad_cat,                
               family = nbinom2, data = dengue)  

parameters(mod_glm, include_info = TRUE, exponentiate = TRUE)
```

------------------------------------------------------------------------

##### GLMM: `departamento` como intercepto aleatorio

```{r}
#| id: GLMM dengue
mod_glmm <- glmmTMB(casos ~ semana_epi + grupo_edad_cat + (1|departamento),
               family = nbinom2, data = dengue)

parameters(mod_glmm, include_info = TRUE, exponentiate = TRUE)
```

------------------------------------------------------------------------

##### Comparo modelos

```{r}
#| id: Comparo GLM y GLMM
compare_performance(mod_glm, mod_glmm, metrics = c("AIC", "BIC"), rank = TRUE)
```

-   Incorporar `departamento` como efecto aleatorio permite que la incidencia difiera sistem√°ticamente entre unidades geogr√°ficas.
-   Si incorporamos `semana_epi` como pendiente aleatoria el modelo no converge, posiblemente por **poca variabilidad** entre departamentos o datos **desbalanceados**.

------------------------------------------------------------------------

### Modelos multinivel

-   En algunos estudios, las observaciones se organizan en **niveles jer√°rquicos** o **anidados** (por ejemplo, pacientes dentro de hospitales, y hospitales dentro de ciudades).

-   Cada nivel jer√°rquico tiene su **propio intercepto aleatorio**, capturando la variabilidad entre unidades dentro de cada nivel.

-   Estos modelos permiten incluir variables explicativas **individuales y contextuales** y descomponer la variabilidad en **componentes de varianza** para cada nivel.

------------------------------------------------------------------------

#### Efectos aleatorios anidados y cruzados

-   Efectos **anidados:**

    -   Se utilizan cuando cada nivel inferior pertenece a un √∫nico nivel superior.

    -   Se especifican como `(1|nivel1/nivel2)`, que equivale a: `(1 | nivel1) + (1 | nivel1:nivel2)`.

-   Efectos **cruzados**:

    -   Se utilizan cuando los factores var√≠an independientemente.

    -   Se especifican como `(1|nivel1) + (1|nivel2)`.

    -   Son **menos frecuentes** en la pr√°ctica.

------------------------------------------------------------------------

##### Ejemplo: Seroprevalencia de SARS-CoV2 en PBA

El dataset `seroprevalencia.csv` tiene dise√±o jer√°rquico: trabajadores dentro de **hospitales**, y hospitales dentro de **estratos** (interzonales vs. municipales).

```{r}
#| id: Cargar datos covid
covid <- read_csv2("seroprevalencia.txt")  |>
select(estrato, hospital, edad, sexo, epp, ig_g, ponde_base) |>
mutate(ig_g = if_else(ig_g == "Reactivo", 1, 0)) |> # Respuesta binomial
mutate(epp = if_else(str_detect(epp, "La ma|Siempre"), "Si", "No"))

glimpse(covid)
```

-   Ajustaremos un modelo para seroprevalencia seg√∫n sexo, edad y uso de EPP que refleje la estructura anidada.

------------------------------------------------------------------------

##### GLMM multinivel

```{r}
#| id: GLMM multinivel
mod_nest <- glmmTMB(
  ig_g ~ sexo + edad + epp + (1 | estrato / hospital),
  family = binomial, data = covid
)

parameters(mod_nest, include_info = TRUE, exponentiate = TRUE)
```

------------------------------------------------------------------------

##### Interpretaci√≥n

-   **Efectos fijos:** `sexo`, `edad` y `epp`.

-   **Efectos aleatorios:** `hospitales` anidados en `estratos`.

-   El modelo estima la probabilidad de IgG reactivo considerando la dependencia intra-hospital en la **muestra**.

-   Para inferir a la **poblaci√≥n**, deber√≠amos incorporar el t√©rmino `weights = ponde_base`.

-   En este ejemplo, la ponderaci√≥n produce **sobreajuste** y **par√°metros inestables**.

------------------------------------------------------------------------

### Resumen: diferencias entre LMM y GLMM

```{r}
#| id: Tabla LMM vs GLMM
#| echo: false

# Generar datos
tibble(
    "Caracter√≠stica" = c(
        "Distribuci√≥n de la VR",
        "Escala de interpretaci√≥n",
        "Efectos fijos",
        "Efectos aleatorios",
        "M√©todo de estimaci√≥n",
        "Interpretaci√≥n varianza"),
    LMM = c(
        "Normal",
        "Original de la VR",
        "Cambios absolutos en la media",
        "Desv√≠os del intercepto y/o pendiente en la media",
        "ML o REML",
        "Escala original"),
    GLMM = c(
        "Binomial, Poisson, Gamma, etc.",
        "Escala de la funci√≥n de enlace",
        "Cambios en la media transformada",
        "Desv√≠os del intercepto y/o pendiente en la escala transformada",
        "ML con integraci√≥n",
        "Escala transformada"
    )
) |>

# Crear tabla
flextable() |>
bold(part = "header") |>
font(fontname = "Calibri", part = "all") |>
fontsize(size = 20, part = "all") |>
autofit()
```

------------------------------------------------------------------------

### Alternativas a los modelos mixtos

```{r}
#| id: Tabla alternativas GLMM
#| echo: false
# Generar datos
tibble(
    Modelo = c(
        "GLMM",
        "GLS",
        "GAM o GAMM",
        "Bayesianos"
        ),
    Enfoque = c(
        "Efectos espec√≠ficos (nivel o unidad de agrupamiento)",
        "Efectos promedio con estructura de correlaci√≥n definida",
        "Relaciones no lineales mediante funciones suaves",
        "Estimaci√≥n completa de par√°metros bajo distribuciones a priori"
    ),
    Utilidad = c(
        "Datos jer√°rquicos o medidas repetidas con variabilidad entre cl√∫sters",
        "Dependencia temporal o espacial sin necesidad de efectos aleatorios expl√≠citos",
        "Captura de curvaturas, estacionalidad o patrones no lineales",
        "Datos escasos, modelos complejos o incumplimiento de supuestos frecuentistas"
    ),
    Paquetes = c(
        "nlme, lme4, glmmTMB",
        "nlme",
        "mgcv",
        "brms, INLA"
    )
) |> 

# Crear tabla
flextable() |>
bold(part = "header") |>
font(fontname = "Calibri", part = "all") |>
fontsize(size = 20, part = "all") |>
autofit()

```

------------------------------------------------------------------------

### Referencias

::: hidden
[@agresti2015; @fieberg2024; @mixed-ef2000; @bates2015; @brooks2017]
:::

::: {#refs}
:::

------------------------------------------------------------------------

## Muchas gracias!!!
:::: {.columns}
::: {.column width="60%"}
üí¨ **Preguntas o comentarios**

üìß *tamararicardo83@gmail.com*

üèõÔ∏è Instituto Nacional de Epidemiolog√≠a "Dr. Juan H. Jara"
:::

::: {.column width="40%"}
![](dt-1.webp){fig-align="center"}
:::
::::